<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHIP.MU</title>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="CHIP.STREAM">
<meta name="theme-color" content="#0d0d0d">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:        #0d0d0d;
  --sidebar:   #111111;
  --card:      #1a1a1a;
  --card2:     #222222;
  --hover:     #2a2a2a;
  --border:    #2c2c2c;
  --text:      #ffffff;
  --sub:       #b3b3b3;
  --dim:       #6a6a6a;
  --accent:    #1db954;
  --accent2:   #1ed760;
  --red:       #ff4455;
  --rainbow:   linear-gradient(90deg,#ff0055,#ff9900,#ffee00,#00dd66,#00aaff,#aa55ff);
  --player-h:  88px;
  --sidebar-w: 260px;
  --radius:    8px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: "Figtree", system-ui, sans-serif;
  font-size: 14px;
  overflow: hidden;
}

/* ── App Shell ─────────────────────────────────────────── */
#app {
  height: 100vh;
  display: grid;
  grid-template-rows: 1fr var(--player-h);
  grid-template-columns: var(--sidebar-w) 1fr;
  grid-template-areas:
    "sidebar main"
    "player  player";
}

/* ── Sidebar ───────────────────────────────────────────── */
#sidebar {
  grid-area: sidebar;
  background: var(--sidebar);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-right: 1px solid var(--border);
}

.sidebar-logo {
  padding: 24px 20px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.logo-mark {
  width: 36px; height: 36px;
  border-radius: 6px;
  background: var(--rainbow);
  display: grid;
  place-items: center;
  font-size: 18px;
  flex-shrink: 0;
}

.logo-text {
  display: flex;
  flex-direction: column;
}

.logo-name {
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 0.5px;
  color: var(--text);
}

.logo-sub {
  font-size: 10px;
  color: var(--dim);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-top: 1px;
}

.sidebar-nav {
  padding: 12px 8px;
  flex-shrink: 0;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-radius: var(--radius);
  color: var(--sub);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
  user-select: none;
}

.nav-item:hover { background: var(--hover); color: var(--text); }
.nav-item.active { background: var(--card2); color: var(--text); }

.nav-icon {
  width: 18px; height: 18px;
  opacity: 0.7;
  flex-shrink: 0;
}

.nav-item.active .nav-icon,
.nav-item:hover .nav-icon { opacity: 1; }

.sidebar-section-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--dim);
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 16px 20px 8px;
  flex-shrink: 0;
}

.sidebar-stats {
  padding: 8px 20px;
  font-size: 12px;
  color: var(--dim);
  flex-shrink: 0;
}

.sidebar-bottom {
  margin-top: auto;
  padding: 12px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}

.upload-trigger {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: var(--radius);
  background: var(--card);
  color: var(--sub);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
  border: 1px solid var(--border);
}

.upload-trigger:hover { background: var(--card2); color: var(--text); }

/* ── Main ──────────────────────────────────────────────── */
#main {
  grid-area: main;
  overflow-y: auto;
  background: var(--bg);
  position: relative;
}

#main::-webkit-scrollbar { width: 6px; }
#main::-webkit-scrollbar-track { background: transparent; }
#main::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* Gradient header fade */
.main-header-bg {
  position: sticky;
  top: 0;
  z-index: 10;
  background: linear-gradient(to bottom, rgba(13,13,13,0.95) 0%, rgba(13,13,13,0) 100%);
  padding: 16px 24px;
  pointer-events: none;
}

.main-content {
  padding: 0 24px 24px;
  margin-top: -60px; /* overlap header */
}

/* ── Now Playing Hero ──────────────────────────────────── */
#now-playing-hero {
  padding: 20px 24px 24px;
  position: relative;
  overflow: hidden;
}

.hero-gradient {
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom, rgba(29,185,84,0.08) 0%, transparent 100%);
  pointer-events: none;
  transition: background 1s ease;
}

.hero-inner {
  display: flex;
  gap: 24px;
  align-items: flex-end;
  position: relative;
}

/* Album art */
.art-wrap {
  width: 160px; height: 160px;
  flex-shrink: 0;
  border-radius: 4px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,0.7);
  position: relative;
  background: var(--card);
}

#pixel-canvas {
  width: 160px; height: 160px;
  image-rendering: pixelated;
  display: block;
}

.art-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 60%);
  pointer-events: none;
}

/* Song info in hero */
.hero-info {
  flex: 1;
  min-width: 0;
  padding-bottom: 4px;
}

.hero-type {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--sub);
  margin-bottom: 8px;
}

.hero-title {
  font-size: 32px;
  font-weight: 700;
  line-height: 1.1;
  margin-bottom: 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.hero-meta {
  font-size: 13px;
  color: var(--sub);
  display: flex;
  align-items: center;
  gap: 6px;
}

.hero-dot { color: var(--dim); }

/* ── Controls Bar ──────────────────────────────────────── */
.controls-bar {
  padding: 20px 24px 0;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.controls-row {
  display: flex;
  align-items: center;
  gap: 16px;
}

/* Icon buttons */
.icon-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--sub);
  padding: 8px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  transition: all 0.15s;
  flex-shrink: 0;
}

.icon-btn:hover { color: var(--text); }
.icon-btn.active { color: var(--accent); }

.play-btn {
  width: 56px; height: 56px;
  background: var(--text);
  color: #000 !important;
  border-radius: 50%;
  display: grid;
  place-items: center;
  border: none;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
}

.play-btn:hover {
  transform: scale(1.06);
  background: #e0e0e0;
}

.play-btn:active { transform: scale(0.97); }

/* SVG icon helpers */
.icon {
  width: 22px; height: 22px;
  fill: currentColor;
}

.icon-sm { width: 18px; height: 18px; fill: currentColor; }
.icon-lg { width: 28px; height: 28px; fill: currentColor; }

/* Progress */
.progress-section {
  display: flex;
  align-items: center;
  gap: 10px;
}

.prog-time {
  font-size: 11px;
  color: var(--dim);
  min-width: 35px;
  font-variant-numeric: tabular-nums;
}

.prog-time.right { text-align: right; }

.prog-wrap {
  flex: 1;
  height: 4px;
  background: var(--card2);
  border-radius: 2px;
  cursor: pointer;
  position: relative;
  overflow: visible;
}

.prog-wrap:hover .prog-fill { background: var(--accent2); }
.prog-wrap:hover .prog-thumb { opacity: 1; }

.prog-fill {
  height: 100%;
  background: var(--text);
  border-radius: 2px;
  width: 0%;
  transition: width 0.5s linear;
  position: relative;
  pointer-events: none;
}

.prog-thumb {
  position: absolute;
  right: -6px;
  top: 50%;
  transform: translateY(-50%);
  width: 12px; height: 12px;
  background: var(--text);
  border-radius: 50%;
  opacity: 0;
  transition: opacity 0.15s;
  pointer-events: none;
}

/* Volume */
.vol-section {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: auto;
}

.vol-icon { color: var(--sub); }

input[type=range].vol-slider {
  -webkit-appearance: none;
  width: 90px;
  height: 4px;
  background: var(--card2);
  outline: none;
  cursor: pointer;
  border-radius: 2px;
}

input[type=range].vol-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px; height: 12px;
  background: var(--text);
  border-radius: 50%;
}

input[type=range].vol-slider:hover {
  background: var(--hover);
}

/* EQ bars */
.eq-bars {
  display: flex;
  gap: 2px;
  align-items: flex-end;
  height: 16px;
}

.eq-bar {
  width: 3px;
  border-radius: 1.5px;
  background: var(--accent);
  animation: eq-bounce 0.5s ease-in-out infinite alternate;
}

.eq-bar:nth-child(2) { animation-delay: 0.1s; }
.eq-bar:nth-child(3) { animation-delay: 0.2s; }
.eq-bar:nth-child(4) { animation-delay: 0.15s; }
.eq-bar:nth-child(5) { animation-delay: 0.05s; }
.eq-bar:nth-child(6) { animation-delay: 0.25s; }

@keyframes eq-bounce {
  from { height: 3px; }
  to   { height: 16px; }
}

.eq-bars.paused .eq-bar { animation-play-state: paused; height: 3px; }

/* ── Visualizer ────────────────────────────────────────── */
.vis-section {
  padding: 0 24px;
  margin-top: 4px;
}

#visualizer {
  width: 100%;
  height: 48px;
  display: block;
  border-radius: var(--radius);
  overflow: hidden;
}

/* ── Song List Section ─────────────────────────────────── */
#song-list-section {
  padding: 24px 24px 0;
  display: none;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.section-title {
  font-size: 20px;
  font-weight: 700;
}

.search-wrap {
  position: relative;
  width: 240px;
}

.search-icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--dim);
  width: 16px; height: 16px;
  fill: currentColor;
}

.search-input {
  width: 100%;
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  padding: 8px 12px 8px 34px;
  outline: none;
  border-radius: 20px;
  transition: all 0.15s;
}

.search-input:focus {
  border-color: var(--text);
  background: var(--card2);
}

.search-input::placeholder { color: var(--dim); }

/* Song table */
.song-list-header {
  display: grid;
  grid-template-columns: 32px 1fr 60px 100px 40px;
  gap: 8px;
  padding: 6px 16px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 4px;
}

.song-list-header span {
  font-size: 11px;
  font-weight: 600;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.song-row {
  display: grid;
  grid-template-columns: 32px 1fr 60px 100px 40px;
  gap: 8px;
  padding: 8px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: background 0.15s;
  align-items: center;
}

.song-row:hover { background: var(--card); }
.song-row:hover .song-num { display: none; }
.song-row:hover .song-play-icon { display: grid; }

.song-row.active {
  background: rgba(29,185,84,0.08);
}

.song-row.active .song-name { color: var(--accent); }
.song-row.active .song-num { display: none; }
.song-row.active .song-play-icon { display: grid; }
.song-row.active .song-play-icon svg { color: var(--accent); }

.song-num {
  font-size: 13px;
  color: var(--dim);
  text-align: right;
  display: flex;
  align-items: center;
  justify-content: flex-end;
}

.song-play-icon {
  display: none;
  place-items: center;
  color: var(--text);
}

.song-name {
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.song-ext {
  font-size: 12px;
  color: var(--sub);
  background: var(--card2);
  border-radius: 4px;
  padding: 2px 8px;
  text-align: center;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.song-date {
  font-size: 12px;
  color: var(--dim);
}

.song-del-wrap {
  display: flex;
  justify-content: flex-end;
}

.del-btn {
  background: none;
  border: none;
  color: var(--dim);
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  display: grid;
  place-items: center;
  opacity: 0;
  transition: all 0.15s;
}

.song-row:hover .del-btn { opacity: 1; }
.del-btn:hover { color: var(--red); background: rgba(255,68,85,0.1); }

.empty {
  text-align: center;
  color: var(--dim);
  padding: 60px 20px;
  font-size: 14px;
  line-height: 2;
}

.song-loading {
  padding: 40px;
  text-align: center;
  color: var(--dim);
  font-size: 13px;
}

/* ── Upload Panel ──────────────────────────────────────── */
#upload-panel {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 200;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  align-items: center;
  justify-content: center;
}

#upload-panel.open { display: flex; }

.upload-modal {
  background: #1e1e1e;
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 32px;
  width: 480px;
  max-width: 90vw;
  position: relative;
  box-shadow: 0 40px 80px rgba(0,0,0,0.6);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
}

.modal-close {
  background: var(--card2);
  border: none;
  color: var(--sub);
  cursor: pointer;
  width: 32px; height: 32px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: 16px;
  transition: all 0.15s;
}

.modal-close:hover { background: var(--hover); color: var(--text); }

.file-drop {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  margin-bottom: 16px;
}

.file-drop:hover, .file-drop.drag-over {
  border-color: var(--accent);
  background: rgba(29,185,84,0.06);
}

.file-drop input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

.drop-icon {
  width: 48px; height: 48px;
  fill: var(--dim);
  margin: 0 auto 12px;
  display: block;
}

.drop-text {
  font-size: 15px;
  font-weight: 600;
  color: var(--sub);
  margin-bottom: 6px;
}

.drop-sub {
  font-size: 12px;
  color: var(--dim);
}

#file-label {
  font-size: 13px;
  color: var(--accent);
  margin-top: 10px;
  font-weight: 600;
}

.upload-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.btn-primary {
  background: var(--text);
  color: #000;
  border: none;
  border-radius: 20px;
  padding: 10px 24px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
}

.btn-primary:hover { background: #e0e0e0; transform: scale(1.02); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

#upload-status {
  font-size: 13px;
  color: var(--sub);
}

/* ── Player Bar ────────────────────────────────────────── */
#player-bar {
  grid-area: player;
  background: #181818;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 16px;
  z-index: 100;
}

.player-left {
  display: flex;
  align-items: center;
  gap: 12px;
  width: var(--sidebar-w);
  flex-shrink: 0;
}

.player-art {
  width: 56px; height: 56px;
  border-radius: 4px;
  overflow: hidden;
  flex-shrink: 0;
  background: var(--card);
}

#player-pixel-canvas {
  width: 56px; height: 56px;
  image-rendering: pixelated;
  display: block;
}

.player-track-info {
  min-width: 0;
}

.player-title {
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 140px;
}

.player-meta {
  font-size: 11px;
  color: var(--sub);
  margin-top: 2px;
}

.player-center {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.player-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.player-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--sub);
  padding: 6px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  transition: all 0.15s;
}

.player-btn:hover { color: var(--text); }

.player-play-btn {
  width: 36px; height: 36px;
  background: var(--text);
  color: #000 !important;
  border-radius: 50%;
  display: grid;
  place-items: center;
  border: none;
  cursor: pointer;
  transition: all 0.15s;
}

.player-play-btn:hover { transform: scale(1.06); background: #e0e0e0; }

.player-progress {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  max-width: 460px;
}

.player-time {
  font-size: 11px;
  color: var(--dim);
  min-width: 32px;
  font-variant-numeric: tabular-nums;
}

.player-time.right { text-align: right; }

.player-prog-wrap {
  flex: 1;
  height: 4px;
  background: var(--card2);
  border-radius: 2px;
  cursor: pointer;
  position: relative;
  overflow: visible;
}

.player-prog-wrap:hover .player-prog-fill { background: var(--accent2); }
.player-prog-wrap:hover .player-prog-thumb { opacity: 1; }

.player-prog-fill {
  height: 100%;
  background: var(--sub);
  border-radius: 2px;
  width: 0%;
  transition: width 0.5s linear;
  pointer-events: none;
}

.player-prog-thumb {
  position: absolute;
  right: -6px;
  top: 50%;
  transform: translateY(-50%);
  width: 12px; height: 12px;
  background: var(--text);
  border-radius: 50%;
  opacity: 0;
  transition: opacity 0.15s;
  pointer-events: none;
}

.player-right {
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: flex-end;
  width: 180px;
  flex-shrink: 0;
}

.player-right .eq-bars {
  height: 14px;
}
.player-right .eq-bar { width: 2.5px; }

/* ── Toast ─────────────────────────────────────────────── */
#toast {
  position: fixed;
  bottom: calc(var(--player-h) + 16px);
  right: 24px;
  background: #282828;
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  padding: 12px 18px;
  display: none;
  z-index: 10000;
  max-width: 280px;
  line-height: 1.5;
  border-radius: var(--radius);
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  border-left: 3px solid var(--dim);
}

#toast.error   { border-left-color: var(--red); }
#toast.success { border-left-color: var(--accent); }

/* ── Scrollable song list ───────────────────────────────── */
.songs-scroll {
  max-height: calc(100vh - 300px);
  overflow-y: auto;
}

.songs-scroll::-webkit-scrollbar { width: 4px; }
.songs-scroll::-webkit-scrollbar-track { background: transparent; }
.songs-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* ── Status footer ─────────────────────────────────────── */
.footer-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 24px;
  font-size: 11px;
  color: var(--dim);
  letter-spacing: 1px;
  text-transform: uppercase;
  border-top: 1px solid rgba(255,255,255,0.04);
  margin-top: auto;
}

/* ── Responsive ────────────────────────────────────────── */
@media (max-width: 640px) {
  :root { --sidebar-w: 0px; }
  #sidebar { display: none; }
  #app { grid-template-columns: 1fr; }
  .hero-title { font-size: 22px; }
  .art-wrap { width: 100px; height: 100px; }
  #pixel-canvas { width: 100px; height: 100px; }
  .player-left { width: auto; }
  .player-right { display: none; }
}

/* ── Page tab switching ─────────────────────────────────── */
#page-home, #page-songs {
  display: none;
}
#page-home.active, #page-songs.active {
  display: block;
}

/* ── Gradient mesh bg ──────────────────────────────────── */
.hero-mesh {
  position: absolute;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
}

.hero-mesh::before {
  content: '';
  position: absolute;
  top: -40px; left: -40px;
  width: 200px; height: 200px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(29,185,84,0.12) 0%, transparent 70%);
  filter: blur(20px);
}

.hero-mesh::after {
  content: '';
  position: absolute;
  top: -20px; right: 60px;
  width: 150px; height: 150px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(0,170,255,0.07) 0%, transparent 70%);
  filter: blur(20px);
}

.rainbow-bar {
  height: 2px;
  background: var(--rainbow);
  width: 100%;
  border-radius: 1px;
  margin-bottom: 4px;
  opacity: 0.6;
}

/* Sticky header for main */
.sticky-top {
  position: sticky;
  top: 0;
  z-index: 20;
  background: rgba(13,13,13,0.9);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}

.sticky-title {
  font-size: 16px;
  font-weight: 700;
}

.sticky-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.btn-ghost {
  background: none;
  border: 1px solid var(--border);
  color: var(--sub);
  padding: 6px 14px;
  border-radius: 20px;
  font-family: inherit;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}

.btn-ghost:hover { border-color: var(--text); color: var(--text); }

/* Gradient badge */
.badge-rainbow {
  display: inline-block;
  background: var(--rainbow);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 2px;
}

</style>
</head>
<body>
<div id="app">

  <!-- ── Sidebar ─────────────────────────────────────── -->
  <nav id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-mark">♪</div>
      <div class="logo-text">
        <div class="logo-name">CHIP.MU</div>
        <div class="logo-sub badge-rainbow">streaming</div>
      </div>
    </div>

    <div class="sidebar-nav">
      <div class="nav-item active" id="nav-home" onclick="showPage('home')">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        ホーム
      </div>
      <div class="nav-item" id="nav-songs" onclick="showPage('songs')">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>
        曲一覧
      </div>
    </div>

    <div class="sidebar-section-label">ライブラリ</div>
    <div class="sidebar-stats" id="sb-count-sidebar">SONGS: 0</div>

    <div class="sidebar-bottom">
      <div class="upload-trigger" onclick="openUpload()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        アップロード
      </div>
    </div>
  </nav>

  <!-- ── Main ────────────────────────────────────────── -->
  <div id="main">

    <!-- Home page -->
    <div id="page-home" class="active">
      <!-- Sticky top bar -->
      <div class="sticky-top">
        <span class="sticky-title">CHIP.STREAM</span>
        <div class="sticky-actions">
          <div class="eq-bars paused" id="eq-bars-top" style="height:14px">
            <div class="eq-bar" style="height:5px"></div>
            <div class="eq-bar" style="height:10px"></div>
            <div class="eq-bar" style="height:4px"></div>
            <div class="eq-bar" style="height:14px"></div>
            <div class="eq-bar" style="height:7px"></div>
            <div class="eq-bar" style="height:9px"></div>
          </div>
          <span id="sb-time" style="font-size:11px;color:var(--dim);letter-spacing:1px;min-width:60px;text-align:right"></span>
        </div>
      </div>

      <!-- Hero now playing -->
      <section id="now-playing-hero">
        <div class="hero-mesh"></div>
        <div class="hero-gradient"></div>
        <div class="hero-inner">
          <div class="art-wrap">
            <canvas id="pixel-canvas" width="16" height="16"></canvas>
            <div class="art-overlay"></div>
          </div>
          <div class="hero-info">
            <div class="hero-type">再生中</div>
            <div class="hero-title" id="hero-title">— — —</div>
            <div class="hero-meta">
              <span class="badge-rainbow">CHIP.MU</span>
              <span class="hero-dot">·</span>
              <span id="hero-meta-text" style="color:var(--sub);font-size:13px">曲を選択してください</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Controls -->
      <div class="controls-bar">
        <div class="controls-row">
          <button class="icon-btn" id="btn-prev" title="前へ">
            <svg class="icon" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
          </button>
          <button class="play-btn" id="btn-play" title="再生/一時停止">
            <svg id="play-icon" class="icon-lg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          </button>
          <button class="icon-btn" id="btn-next" title="次へ（ランダム）">
            <svg class="icon" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zm2-8.14L11.03 12 8 14.14V9.86zM16 6h2v12h-2z"/></svg>
          </button>
          <div class="eq-bars paused" id="eq-bars" style="margin-left:8px">
            <div class="eq-bar" style="height:8px"></div>
            <div class="eq-bar" style="height:16px"></div>
            <div class="eq-bar" style="height:6px"></div>
            <div class="eq-bar" style="height:20px"></div>
            <div class="eq-bar" style="height:10px"></div>
            <div class="eq-bar" style="height:14px"></div>
          </div>
          <div class="vol-section">
            <svg class="icon-sm vol-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
            <input type="range" class="vol-slider" id="volume" min="0" max="1" step="0.01" value="0.8">
          </div>
        </div>
        <div class="progress-section">
          <span class="prog-time" id="t-cur">0:00</span>
          <div class="prog-wrap" id="prog-wrap">
            <div class="prog-fill" id="prog-fill">
              <div class="prog-thumb"></div>
            </div>
          </div>
          <span class="prog-time right" id="t-dur">0:00</span>
        </div>
      </div>

      <!-- Visualizer -->
      <div class="vis-section">
        <div class="rainbow-bar"></div>
        <canvas id="visualizer"></canvas>
      </div>

      <!-- Footer -->
      <div class="footer-bar">
        <span id="sb-count">SONGS: 0</span>
        <span>CHIP.STREAM</span>
      </div>
    </div>

    <!-- Songs page -->
    <div id="page-songs">
      <div class="sticky-top">
        <span class="sticky-title">曲一覧</span>
        <div class="sticky-actions">
          <button class="btn-ghost" id="btn-refresh">更新</button>
        </div>
      </div>

      <div id="song-list-section" style="display:block">
        <div style="padding:16px 24px 8px">
          <div class="search-wrap">
            <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" class="search-input" id="search" placeholder="検索...">
          </div>
        </div>

        <div class="song-list-header">
          <span>#</span>
          <span>タイトル</span>
          <span>形式</span>
          <span>日付</span>
          <span></span>
        </div>

        <div class="songs-scroll">
          <div id="song-tbody">
            <div class="song-loading">読み込み中...</div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- #main -->

  <!-- ── Bottom Player Bar ────────────────────────────── -->
  <div id="player-bar">
    <div class="player-left">
      <div class="player-art">
        <canvas id="player-pixel-canvas" width="16" height="16"></canvas>
      </div>
      <div class="player-track-info">
        <div class="player-title" id="player-title">—</div>
        <div class="player-meta badge-rainbow" id="player-meta">CHIP.MU</div>
      </div>
    </div>

    <div class="player-center">
      <div class="player-controls">
        <button class="player-btn" id="pb-prev" title="前へ">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg>
        </button>
        <button class="player-play-btn" id="pb-play">
          <svg id="pb-play-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <button class="player-btn" id="pb-next" title="次へ">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zm2-8.14L11.03 12 8 14.14V9.86zM16 6h2v12h-2z"/></svg>
        </button>
      </div>
      <div class="player-progress">
        <span class="player-time" id="pb-cur">0:00</span>
        <div class="player-prog-wrap" id="pb-prog-wrap">
          <div class="player-prog-fill" id="pb-prog-fill">
            <div class="player-prog-thumb"></div>
          </div>
        </div>
        <span class="player-time right" id="pb-dur">0:00</span>
      </div>
    </div>

    <div class="player-right">
      <div class="eq-bars paused" id="pb-eq-bars" style="height:14px">
        <div class="eq-bar" style="height:5px"></div>
        <div class="eq-bar" style="height:10px"></div>
        <div class="eq-bar" style="height:4px"></div>
        <div class="eq-bar" style="height:14px"></div>
        <div class="eq-bar" style="height:7px"></div>
        <div class="eq-bar" style="height:9px"></div>
      </div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="color:var(--sub)"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
      <input type="range" class="vol-slider" id="pb-volume" min="0" max="1" step="0.01" value="0.8" style="width:80px">
    </div>
  </div>

</div><!-- #app -->

<!-- Upload Modal -->
<div id="upload-panel">
  <div class="upload-modal">
    <div class="modal-header">
      <div class="modal-title">アップロード</div>
      <button class="modal-close" onclick="closeUpload()">✕</button>
    </div>
    <div class="file-drop" id="file-drop">
      <input type="file" id="u-file" accept=".mp3,.ogg,.wav,.flac,.mod,.xm,.s3m,.it,.nsf,.spc,.gbs,.vgm,.vgz">
      <svg class="drop-icon" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
      <div class="drop-text">ここにファイルをドロップ</div>
      <div class="drop-sub">MP3 / OGG / WAV / FLAC / MOD / XM / NSF / SPC…</div>
      <div id="file-label"></div>
    </div>
    <div class="upload-actions">
      <button class="btn-primary" id="btn-upload">アップロード</button>
      <span id="upload-status"></span>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Hidden audio element -->
<audio id="player" preload="none" playsinline></audio>

<script>
// ── State ─────────────────────────────────────────────
const API    = '';
let songs    = [];
let current  = null;
let historyQ = [];
let isPlaying= false;
let audioCtx = null;
let analyser = null;
let srcNode  = null;
let visRaf   = null;

// ── Elements ──────────────────────────────────────────
const player       = document.getElementById('player');
const btnPlay      = document.getElementById('btn-play');
const btnNext      = document.getElementById('btn-next');
const btnPrev      = document.getElementById('btn-prev');
const pbPlay       = document.getElementById('pb-play');
const pbNext       = document.getElementById('pb-next');
const pbPrev       = document.getElementById('pb-prev');
const progFill     = document.getElementById('prog-fill');
const progWrap     = document.getElementById('prog-wrap');
const pbProgFill   = document.getElementById('pb-prog-fill');
const pbProgWrap   = document.getElementById('pb-prog-wrap');
const tCur         = document.getElementById('t-cur');
const tDur         = document.getElementById('t-dur');
const pbCur        = document.getElementById('pb-cur');
const pbDur        = document.getElementById('pb-dur');
const eqBars       = document.getElementById('eq-bars');
const eqBarsTop    = document.getElementById('eq-bars-top');
const pbEqBars     = document.getElementById('pb-eq-bars');
const volSlider    = document.getElementById('volume');
const pbVolSlider  = document.getElementById('pb-volume');
const visCanvas    = document.getElementById('visualizer');
const visCtx2      = visCanvas.getContext('2d');
const pxCanvas     = document.getElementById('pixel-canvas');
const pxCtx        = pxCanvas.getContext('2d');
const ppxCanvas    = document.getElementById('player-pixel-canvas');
const ppxCtx       = ppxCanvas.getContext('2d');
const tbody        = document.getElementById('song-tbody');
const searchIn     = document.getElementById('search');
const toast        = document.getElementById('toast');
const sbCount      = document.getElementById('sb-count');
const sbCountSb    = document.getElementById('sb-count-sidebar');
const sbTime       = document.getElementById('sb-time');
const heroTitle    = document.getElementById('hero-title');
const heroMeta     = document.getElementById('hero-meta-text');
const playerTitle  = document.getElementById('player-title');
const playIcon     = document.getElementById('play-icon');
const pbPlayIcon   = document.getElementById('pb-play-icon');

// ── Page switching ─────────────────────────────────────
function showPage(name) {
  document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
}

// ── Upload panel ───────────────────────────────────────
function openUpload()  { document.getElementById('upload-panel').classList.add('open'); }
function closeUpload() { document.getElementById('upload-panel').classList.remove('open'); }
document.getElementById('upload-panel').addEventListener('click', e => {
  if (e.target === document.getElementById('upload-panel')) closeUpload();
});

// ── Toast ──────────────────────────────────────────────
let toastTimer;
function showToast(msg, type='info') {
  toast.textContent = msg;
  toast.className   = type;
  toast.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.style.display='none', 3000);
}

// ── Time format ────────────────────────────────────────
function fmt(s) {
  if (!isFinite(s) || s < 0) return '0:00';
  const m = Math.floor(s / 60), ss = Math.floor(s % 60);
  return `${m}:${ss.toString().padStart(2,'0')}`;
}

// ── Status clock ───────────────────────────────────────
setInterval(() => {
  sbTime.textContent = new Date().toLocaleTimeString('ja-JP', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
}, 1000);

// ── Pixel art ─────────────────────────────────────────
function drawPixelArt(seed, ctx) {
  const pal = ['#00ffcc','#ff00aa','#ffcc00','#ff4466','#44ff88','#0088ff','#ff8800','#cc44ff','#00ccff','#ff6644'];
  const rng = s => { let v=s; return () => { v=(v*1664525+1013904223)&0xffffffff; return (v>>>0)/0xffffffff; }; };
  const r = rng(seed||42);
  const W = 8;
  ctx.clearRect(0,0,16,16);
  for (let y=0;y<W;y++) {
    for (let x=0;x<W/2;x++) {
      if (r()>0.4) {
        const col=pal[Math.floor(r()*pal.length)];
        ctx.fillStyle=col;
        ctx.fillRect(x*2,y*2,2,2);
        ctx.fillRect((W-1-x)*2,y*2,2,2);
      }
    }
  }
}

// ── Visualizer ────────────────────────────────────────
function resizeVis() {
  visCanvas.width  = visCanvas.offsetWidth;
  visCanvas.height = visCanvas.offsetHeight;
}
resizeVis();
window.addEventListener('resize', resizeVis);

function drawVis() {
  visRaf = requestAnimationFrame(drawVis);
  const W = visCanvas.width, H = visCanvas.height;
  visCtx2.fillStyle = 'rgba(0,0,0,0.85)';
  visCtx2.fillRect(0,0,W,H);

  if (!analyser) {
    visCtx2.strokeStyle = 'rgba(29,185,84,0.12)';
    visCtx2.lineWidth = 1;
    visCtx2.beginPath();
    visCtx2.moveTo(0,H/2); visCtx2.lineTo(W,H/2);
    visCtx2.stroke();
    return;
  }

  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);

  const barW  = Math.max(2, Math.floor(W / 64));
  const gap   = 1;
  const count = Math.floor(W / (barW + gap));
  const t     = Date.now() / 1000;

  for (let i=0;i<count;i++) {
    const di  = Math.floor(i/count*data.length);
    const val = data[di]/255;
    const bH  = Math.max(2, Math.floor(val*H));
    const hue = (i/count*180+t*60)%360;
    const qH  = Math.floor(bH/4)*4;
    visCtx2.fillStyle = `hsl(${hue},100%,55%)`;
    visCtx2.fillRect(i*(barW+gap), H-qH, barW, qH);
    visCtx2.fillStyle = '#fff';
    visCtx2.fillRect(i*(barW+gap), H-qH, barW, 2);
  }
}
drawVis();

function setupAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)({ latencyHint:'playback', sampleRate:96000 });
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 512;
  srcNode  = audioCtx.createMediaElementSource(player);
  const gain = audioCtx.createGain();
  srcNode.connect(gain);
  gain.connect(analyser);
  analyser.connect(audioCtx.destination);
}

// ── Media Session ─────────────────────────────────────
function setupMediaSession() {
  if (!('mediaSession' in navigator)) return;

  navigator.mediaSession.setActionHandler('play', async () => {
    setupAudio();
    if (audioCtx?.state==='suspended') await audioCtx.resume();
    player.play().then(()=>setPlaying(true)).catch(console.warn);
  });
  navigator.mediaSession.setActionHandler('pause', () => { player.pause(); setPlaying(false); });
  navigator.mediaSession.setActionHandler('nexttrack', () => nextRandom());
  navigator.mediaSession.setActionHandler('previoustrack', () => prevSong());
  navigator.mediaSession.setActionHandler('seekto', e => {
    if (e.seekTime!==undefined && player.duration) player.currentTime=e.seekTime;
  });
  navigator.mediaSession.setActionHandler('seekforward', e => {
    player.currentTime = Math.min(player.duration, player.currentTime+(e.seekOffset||10));
  });
  navigator.mediaSession.setActionHandler('seekbackward', e => {
    player.currentTime = Math.max(0, player.currentTime-(e.seekOffset||10));
  });
}

function updateMediaSessionMetadata() {
  if (!('mediaSession' in navigator)) return;
  const artUrl = pxCanvas.toDataURL('image/png');
  navigator.mediaSession.metadata = new MediaMetadata({
    title:'CHIP.STREAM', artist:'', album:'',
    artwork:[
      {src:artUrl,sizes:'96x96',type:'image/png'},
      {src:artUrl,sizes:'128x128',type:'image/png'},
    ]
  });
}

function updateMediaSessionPlaybackState(playing) {
  if (!('mediaSession' in navigator)) return;
  navigator.mediaSession.playbackState = playing?'playing':'paused';
}

player.addEventListener('timeupdate', () => {
  if (!player.duration||!('mediaSession' in navigator)) return;
  try {
    navigator.mediaSession.setPositionState({ duration:player.duration, playbackRate:player.playbackRate, position:player.currentTime });
  } catch(e) {}
});

setupMediaSession();

// ── Play song ─────────────────────────────────────────
async function playSong(song) {
  if (!song) return;
  if (current) historyQ.push(current.id);
  current = song;

  let seed = 0;
  for (const c of song.id) seed = (seed*31+c.charCodeAt(0))|0;
  drawPixelArt(seed, pxCtx);
  drawPixelArt(seed, ppxCtx);

  // Update hero
  heroTitle.textContent   = song.name || song.id;
  heroMeta.textContent    = (song.ext||'').replace('.','').toUpperCase() + ' · ' + (song.uploaded||'').slice(0,10);
  playerTitle.textContent = song.name || song.id;

  player.src    = `${API}/stream/${song.id}`;
  player.volume = parseFloat(volSlider.value);

  try {
    setupAudio();
    if (audioCtx.state==='suspended') await audioCtx.resume();
    await player.play();
    setPlaying(true);
  } catch(e) {
    console.warn(e);
    showToast('再生エラー: ' + e.message, 'error');
  }

  highlightActive();
  updateMediaSessionMetadata();
}

const PLAY_SVG  = '<path d="M8 5v14l11-7z"/>';
const PAUSE_SVG = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';

function setPlaying(v) {
  isPlaying = v;
  playIcon.innerHTML    = v ? PAUSE_SVG : PLAY_SVG;
  pbPlayIcon.innerHTML  = v ? PAUSE_SVG : PLAY_SVG;
  eqBars.classList.toggle('paused',!v);
  eqBarsTop.classList.toggle('paused',!v);
  pbEqBars.classList.toggle('paused',!v);
  updateMediaSessionPlaybackState(v);
}

// ── Auto-next ─────────────────────────────────────────
player.addEventListener('ended', () => nextRandom());

async function nextRandom() {
  try {
    const excl = current?current.id:'';
    const res  = await fetch(`${API}/api/random?exclude=${excl}`);
    if (!res.ok) return;
    const song = await res.json();
    playSong(song);
  } catch(e) { console.warn(e); }
}

async function prevSong() {
  if (historyQ.length===0) return;
  const prevId = historyQ.pop();
  const song   = songs.find(s=>s.id===prevId);
  if (song) {
    const cur = current;
    current   = null;
    await playSong(song);
  }
}

// ── Controls ──────────────────────────────────────────
async function togglePlay() {
  if (!current) { await nextRandom(); return; }
  setupAudio();
  if (audioCtx.state==='suspended') await audioCtx.resume();
  if (isPlaying) { player.pause(); setPlaying(false); }
  else           { player.play().then(()=>setPlaying(true)).catch(console.warn); }
}

btnPlay.addEventListener('click', togglePlay);
pbPlay.addEventListener('click',  togglePlay);
btnNext.addEventListener('click', nextRandom);
pbNext.addEventListener('click',  nextRandom);
btnPrev.addEventListener('click', prevSong);
pbPrev.addEventListener('click',  prevSong);

volSlider.addEventListener('input', () => {
  player.volume = parseFloat(volSlider.value);
  pbVolSlider.value = volSlider.value;
});
pbVolSlider.addEventListener('input', () => {
  player.volume = parseFloat(pbVolSlider.value);
  volSlider.value = pbVolSlider.value;
});

// Progress (both bars)
player.addEventListener('timeupdate', () => {
  if (!player.duration) return;
  const pct = player.currentTime/player.duration*100;
  progFill.style.width   = pct+'%';
  pbProgFill.style.width = pct+'%';
  const cur = fmt(player.currentTime);
  const dur = fmt(player.duration);
  tCur.textContent  = cur; tDur.textContent  = dur;
  pbCur.textContent = cur; pbDur.textContent = dur;
});

function seekByClick(e, wrap) {
  if (!player.duration) return;
  const rect = wrap.getBoundingClientRect();
  player.currentTime = (e.clientX-rect.left)/rect.width*player.duration;
}
progWrap.addEventListener('click',   e => seekByClick(e, progWrap));
pbProgWrap.addEventListener('click', e => seekByClick(e, pbProgWrap));

// ── Song list ─────────────────────────────────────────
async function loadSongs(q='') {
  try {
    const url = q?`${API}/api/songs?q=${encodeURIComponent(q)}`:`${API}/api/songs`;
    const res = await fetch(url);
    songs     = await res.json();
    renderList(songs);
    sbCount.textContent   = `SONGS: ${songs.length}`;
    sbCountSb.textContent = `SONGS: ${songs.length}`;
  } catch(e) {
    tbody.innerHTML = `<div class="empty">読み込みエラー</div>`;
  }
}

function renderList(list) {
  if (list.length===0) {
    tbody.innerHTML = `<div class="empty">曲がありません<br><small>音楽をアップロードしてください</small></div>`;
    return;
  }

  tbody.innerHTML = list.map((s,i) => `
    <div class="song-row${current&&current.id===s.id?' active':''}" data-id="${s.id}">
      <div class="song-num">
        <span class="num-text">${i+1}</span>
        <span class="song-play-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">${current&&current.id===s.id&&isPlaying?'<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'  :'<path d="M8 5v14l11-7z"/>'}</svg>
        </span>
      </div>
      <div class="song-name">${esc(s.name||s.id)}</div>
      <div><span class="song-ext">${(s.ext||'').replace('.','').toUpperCase()}</span></div>
      <div class="song-date">${(s.uploaded||'').slice(0,10)}</div>
      <div class="song-del-wrap"><button class="del-btn" data-id="${s.id}" title="削除">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
      </button></div>
    </div>
  `).join('');

  tbody.querySelectorAll('.song-row').forEach(row => {
    row.addEventListener('click', e => {
      if (e.target.closest('.del-btn')) return;
      const s = songs.find(x=>x.id===row.dataset.id);
      if (s) playSong(s);
    });
  });

  tbody.querySelectorAll('.del-btn').forEach(btn => {
    btn.addEventListener('click', async e => {
      e.stopPropagation();
      if (!confirm('この曲を削除しますか？')) return;
      const id = btn.dataset.id;
      await fetch(`${API}/api/songs/${id}`,{method:'DELETE'});
      if (current&&current.id===id) { player.pause(); setPlaying(false); current=null; }
      loadSongs(searchIn.value.trim());
      showToast('削除しました','error');
    });
  });
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function highlightActive() {
  document.querySelectorAll('.song-row').forEach(r => {
    r.classList.toggle('active', current&&r.dataset.id===current.id);
  });
}

searchIn.addEventListener('input', () => loadSongs(searchIn.value.trim()));
document.getElementById('btn-refresh').addEventListener('click', () => loadSongs(searchIn.value.trim()));

// ── Upload ────────────────────────────────────────────
const fileDrop   = document.getElementById('file-drop');
const fileInput  = document.getElementById('u-file');
const fileLabel  = document.getElementById('file-label');
const uploadStat = document.getElementById('upload-status');

fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) fileLabel.textContent = fileInput.files[0].name;
});

fileDrop.addEventListener('dragover', e => { e.preventDefault(); fileDrop.classList.add('drag-over'); });
fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('drag-over'));
fileDrop.addEventListener('drop', e => {
  e.preventDefault();
  fileDrop.classList.remove('drag-over');
  const f = e.dataTransfer.files[0];
  if (f) { fileInput.files=e.dataTransfer.files; fileLabel.textContent=f.name; }
});

document.getElementById('btn-upload').addEventListener('click', async () => {
  const file = fileInput.files[0];
  if (!file) { showToast('ファイルを選択してください','error'); return; }

  const fd = new FormData();
  fd.append('file', file);
  uploadStat.textContent = 'アップロード中...';
  document.getElementById('btn-upload').disabled = true;

  try {
    const res  = await fetch(`${API}/api/upload`,{method:'POST',body:fd});
    const data = await res.json();
    if (data.ok) {
      showToast('アップロード完了','success');
      uploadStat.textContent = '';
      fileInput.value = '';
      fileLabel.textContent = '';
      closeUpload();
      loadSongs();
    } else {
      showToast('エラー: '+(data.error||'不明'),'error');
      uploadStat.textContent = '失敗';
    }
  } catch(e) {
    showToast('ネットワークエラー','error');
    uploadStat.textContent = 'エラー';
  }
  document.getElementById('btn-upload').disabled = false;
});

// ── Service Worker ────────────────────────────────────
if ('serviceWorker' in navigator) {
  const swCode = `
    self.addEventListener('install', e => self.skipWaiting());
    self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
    self.addEventListener('fetch', e => {
      e.respondWith(fetch(e.request).catch(() => new Response('', {status:503})));
    });
  `;
  const swBlob = new Blob([swCode],{type:'application/javascript'});
  const swUrl  = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl,{scope:'/'}).catch(console.warn);
}

// ── iOS background resume ─────────────────────────────
document.addEventListener('visibilitychange', async () => {
  if (document.visibilityState==='visible'&&audioCtx&&audioCtx.state==='suspended') {
    try { await audioCtx.resume(); } catch(e) { console.warn(e); }
  }
});

// ── Init ──────────────────────────────────────────────
loadSongs();
</script>
</body>
</html>
