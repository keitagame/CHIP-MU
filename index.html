<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHIP.STREAM</title>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="CHIP.STREAM">
<meta name="theme-color" content="#000000">
<style>
/* ── Google Fonts ────────────────────────────────────────── */
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600&display=swap');

/* ── CSS Variables ───────────────────────────────────────── */
:root {
  --bg:       #000000;
  --panel:    #000000;
  --panel2:   #000000;
  --border:   #2b2b2b;
  --text:     #ffffff;
  --dim:      #888888;
  --red:      #ff4455;
  --green:    #44ff88;
  --rainbow:  linear-gradient(90deg, #ff0055, #ff9900, #ffee00, #00dd66, #00aaff, #aa55ff);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ── Base ────────────────────────────────────────────────── */
html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: "Noto Sans JP", system-ui, sans-serif;
  font-size: 14px;
  font-weight: 400;
  overflow-x: hidden;
}

/* ── Layout ──────────────────────────────────────────────── */
#app {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
  display: grid;
  gap: 20px;
}

/* ── Header ──────────────────────────────────────────────── */
header {
  font-size: 22px;
  font-weight: 400;
  border-bottom: 1px solid var(--border);
  padding-bottom: 10px;
}

.logo {
  font-size: 22px;
  font-weight: 400;
  color: var(--text);
  letter-spacing: 1px;
}

.logo span { color: var(--text); }

.tagline {
  font-size: 12px;
  color: var(--dim);
  margin-top: 4px;
  letter-spacing: 1px;
}

/* ── Now Playing ─────────────────────────────────────────── */
#now-playing {
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 18px;
  position: relative;
  overflow: hidden;
}

#now-playing::before {
  content: "";
  position: absolute;
  left: 0; top: 0;
  width: 100%; height: 1px;
  background: linear-gradient(90deg, #ff0055, #ff9900, #ffee00, #00dd66, #00aaff, #aa55ff);
}

.np-inner {
  display: flex;
  gap: 20px;
  align-items: center;
}

/* Pixel art album art placeholder */
.art-pixel {
  width: 80px; height: 80px;
  flex-shrink: 0;
}

#pixel-canvas {
  width: 80px; height: 80px;
  background: #000;
  border: 1px solid var(--border);
  image-rendering: pixelated;
}

.np-info { min-width: 0; flex: 1; }

.np-title {
  font-size: 20px;
  font-weight: 400;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 4px;
}

.np-artist {
  font-size: 14px;
  color: var(--dim);
  margin-bottom: 12px;
}

/* Progress bar */
.prog-wrap {
  background: #000;
  height: 1px;
  position: relative;
  cursor: pointer;
  margin-bottom: 6px;
}

.prog-fill {
  height: 100%;
  background: linear-gradient(90deg, #ff0055, #ff9900, #ffee00, #00dd66, #00aaff, #aa55ff);
  width: 0%;
  transition: width 0.5s linear;
  position: relative;
}

.prog-fill::after {
  display: none;
}

.time-row {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: var(--dim);
  margin-bottom: 12px;
}

/* ── Controls ────────────────────────────────────────────── */
.controls {
  display: flex;
  gap: 10px;
  align-items: center;
}

.btn-px {
  font-family: inherit;
  font-size: 14px;
  padding: 10px 16px;
  background: var(--panel2);
  border: 1px solid var(--border);
  color: var(--text);
  cursor: pointer;
  transition: 0.15s;
  letter-spacing: 0;
}

.btn-px:hover {
  border-image: linear-gradient(#ff0055, #ff9900, #ffee00, #00dd66, #00aaff, #aa55ff) 1;
  border-width: 1px;
  border-style: solid;
}

.btn-px:active {
  opacity: 0.7;
}

.btn-px.primary {
  border-color: var(--border);
  color: var(--text);
}

.btn-px.danger {
  border-color: var(--red);
  color: var(--red);
}

.vol-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--dim);
  flex: 1;
  justify-content: flex-end;
}

input[type=range] {
  -webkit-appearance: none;
  width: 80px;
  height: 1px;
  background: var(--border);
  outline: none;
  cursor: pointer;
}

input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 8px; height: 14px;
  background: #fff;
}

/* ── Waveform visualizer ─────────────────────────────────── */
#visualizer {
  width: 100%;
  height: 36px;
  background: #000;
  border: 1px solid var(--border);
  display: block;
  margin-top: 16px;
}

/* ── Song List ───────────────────────────────────────────── */
#song-list-section {
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 18px;
}

.section-title {
  font-size: 12px;
  color: var(--dim);
  letter-spacing: 1px;
  margin-bottom: 12px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 8px;
}

/* search */
.search-row {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
}

.px-input {
  background: #000;
  border: 1px solid var(--border);
  color: var(--text);
  font-family: inherit;
  font-size: 14px;
  padding: 10px;
  outline: none;
  flex: 1;
  min-width: 0;
}

.px-input:focus {
  border-color: #555;
}

/* song table */
#song-table {
  width: 100%;
  border-collapse: collapse;
}

#song-table th {
  font-size: 12px;
  color: var(--dim);
  text-align: left;
  padding: 4px 8px;
  border-bottom: 1px solid var(--border);
}

#song-table td {
  padding: 12px 8px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  vertical-align: middle;
}

.song-row:hover td { background: #0a0a0a; cursor: pointer; }
.song-row.active {
  border-left: 4px solid;
  border-image: linear-gradient(#ff0055, #ff9900, #ffee00, #00dd66, #00aaff, #aa55ff) 1;
}

.song-row .play-icon { color: var(--dim); font-size: 12px; }
.song-row td.t-num  { color: var(--dim); font-size: 12px; width: 32px; }
.song-row td.t-title { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.song-row td.t-artist { color: var(--dim); }
.song-row td.t-ext  { color: var(--dim); font-size: 12px; }
.song-row td.t-date { color: var(--dim); font-size: 12px; }
.song-row td.t-del  { width: 36px; }

.del-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--dim);
  cursor: pointer;
  font-size: 12px;
  padding: 4px 8px;
  font-family: inherit;
}
.del-btn:hover { border-color: var(--red); color: var(--red); }

/* empty state */
.empty {
  text-align: center;
  color: var(--dim);
  padding: 40px;
  font-size: 14px;
  line-height: 2;
}

/* ── Upload ──────────────────────────────────────────────── */
#upload-section {
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 18px;
}

.upload-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

@media (max-width: 560px) {
  .upload-grid { grid-template-columns: 1fr; }
  .np-inner    { flex-direction: column; align-items: flex-start; }
  .art-pixel   { display: none; }
}

.field-label {
  font-size: 11px;
  color: var(--dim);
  display: block;
  margin-bottom: 6px;
  letter-spacing: 1px;
}

.file-drop {
  grid-column: 1 / -1;
  border: 2px dashed var(--border);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s;
  position: relative;
  font-size: 14px;
  color: var(--dim);
}

.file-drop:hover, .file-drop.drag-over {
  border-color: #00aaff;
  color: #00aaff;
}

.file-drop input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

.upload-actions {
  grid-column: 1 / -1;
  display: flex;
  gap: 10px;
  align-items: center;
}

/* ── Status bar ──────────────────────────────────────────── */
#status-bar {
  font-size: 11px;
  color: var(--dim);
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  letter-spacing: 1px;
  border-top: 1px solid var(--border);
}

/* ── Toast ───────────────────────────────────────────────── */
#toast {
  position: fixed;
  bottom: 24px; right: 24px;
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  padding: 12px 18px;
  display: none;
  z-index: 10000;
  max-width: 280px;
  line-height: 1.6;
}

#toast.error   { border-color: var(--red); color: var(--red); }
#toast.success { border-color: #00dd66; color: #00dd66; }

/* ── Marquee ─────────────────────────────────────────────── */
.marquee-wrap {
  overflow: hidden;
  background: #000;
  border: 1px solid var(--border);
  padding: 4px 8px;
}

.marquee-inner {
  display: inline-block;
  white-space: nowrap;
  animation: marquee 18s linear infinite;
  font-size: 12px;
  color: var(--dim);
  letter-spacing: 2px;
}

@keyframes marquee {
  from { transform: translateX(100vw); }
  to   { transform: translateX(-100%); }
}

/* ── EQ bars animation ───────────────────────────────────── */
.eq-bars {
  display: flex;
  gap: 3px;
  align-items: flex-end;
  height: 20px;
}

.eq-bar {
  width: 3px;
  background: #fff;
  animation: eq-bounce 0.5s ease-in-out infinite alternate;
}

.eq-bar:nth-child(2) { animation-delay: 0.1s; }
.eq-bar:nth-child(3) { animation-delay: 0.2s; }
.eq-bar:nth-child(4) { animation-delay: 0.15s; }
.eq-bar:nth-child(5) { animation-delay: 0.05s; }
.eq-bar:nth-child(6) { animation-delay: 0.25s; }

@keyframes eq-bounce {
  from { height: 3px; }
  to   { height: 20px; }
}

.eq-bars.paused .eq-bar { animation-play-state: paused; height: 3px; }

</style>
</head>
<body>
<div id="app">

  <!-- Header -->
  <header>
    <div class="logo">CHIP.STREAM</div>
    <div class="tagline">music streaming</div>
  </header>

  <!-- Marquee -->
  <div class="marquee-wrap">
    <span class="marquee-inner" id="marquee-text">
      ★ CHIP.STREAM へようこそ ★ 音楽をアップロード ★ ログイン不要 ★
    </span>
  </div>

  <!-- Now Playing -->
  <section id="now-playing">
    <div class="np-inner">
      <div class="art-pixel">
        <canvas id="pixel-canvas" width="16" height="16"></canvas>
      </div>
      <div class="np-info">
        <div class="np-title" id="np-title">曲が選択されていません</div>
        <div class="np-artist" id="np-artist">下のリストから選択</div>

        <div class="prog-wrap" id="prog-wrap">
          <div class="prog-fill" id="prog-fill"></div>
        </div>
        <div class="time-row">
          <span id="t-cur">0:00</span>
          <span id="t-dur">0:00</span>
        </div>

        <div class="controls">
          <button class="btn-px" id="btn-prev" title="Prev">前へ</button>
          <button class="btn-px primary" id="btn-play" title="Play/Pause">再生</button>
          <button class="btn-px" id="btn-next" title="Next Random">次へ</button>
          <div class="eq-bars paused" id="eq-bars">
            <div class="eq-bar" style="height:8px"></div>
            <div class="eq-bar" style="height:16px"></div>
            <div class="eq-bar" style="height:6px"></div>
            <div class="eq-bar" style="height:20px"></div>
            <div class="eq-bar" style="height:10px"></div>
            <div class="eq-bar" style="height:14px"></div>
          </div>
          <div class="vol-row">
            <span>VOL</span>
            <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8">
          </div>
        </div>
      </div>
    </div>
    <canvas id="visualizer"></canvas>
  </section>

  <!-- Song List -->
  <section id="song-list-section">
    <div class="section-title">曲一覧</div>
    <div class="search-row">
      <input type="text" class="px-input" id="search" placeholder="検索">
      <button class="btn-px" id="btn-refresh">更新</button>
    </div>
    <table id="song-table">
      <thead>
        <tr>
          <th>#</th>
          <th>タイトル</th>
          <th>アーティスト</th>
          <th>形式</th>
          <th>日付</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="song-tbody">
        <tr><td colspan="6"><div class="empty">LOADING...</div></td></tr>
      </tbody>
    </table>
  </section>

  <!-- Upload -->
  <section id="upload-section">
    <div class="section-title">アップロード</div>
    <div class="upload-grid">
      <div>
        <label class="field-label" for="u-title">曲タイトル</label>
        <input type="text" class="px-input" id="u-title" placeholder="曲名" style="width:100%">
      </div>
      <div>
        <label class="field-label" for="u-artist">アーティスト名</label>
        <input type="text" class="px-input" id="u-artist" placeholder="アーティスト" style="width:100%">
      </div>
      <div class="file-drop" id="file-drop">
        <input type="file" id="u-file" accept=".mp3,.ogg,.wav,.flac,.mod,.xm,.s3m,.it,.nsf,.spc,.gbs,.vgm,.vgz">
        <div id="file-label">音声ファイルをここにドラッグ<br><small style="font-size:12px;color:var(--dim)">MP3 / OGG / WAV / MOD / XM / NSF / SPC…</small></div>
      </div>
      <div>
        <label class="field-label" for="u-comment">コメント（任意）</label>
        <input type="text" class="px-input" id="u-comment" placeholder="コメント" style="width:100%">
      </div>
      <div class="upload-actions">
        <button class="btn-px primary" id="btn-upload">アップロード</button>
        <span id="upload-status" style="font-size:13px;color:var(--dim)"></span>
      </div>
    </div>
  </section>

  <!-- Status bar -->
  <div id="status-bar">
    <span id="sb-count">SONGS: 0</span>
    <span>CHIP.STREAM</span>
    <span id="sb-time"></span>
  </div>

</div><!-- #app -->

<!-- Toast -->
<div id="toast"></div>

<!-- Hidden audio element -->
<audio id="player" preload="none" playsinline></audio>

<script>
// ── State ─────────────────────────────────────────────────────────────────────
const API    = '';   // same origin
let songs    = [];
let current  = null;
let history  = [];   // for prev
let isPlaying= false;
let audioCtx = null;
let analyser = null;
let srcNode  = null;
let visRaf   = null;

// ── Elements ──────────────────────────────────────────────────────────────────
const player   = document.getElementById('player');
const btnPlay  = document.getElementById('btn-play');
const btnNext  = document.getElementById('btn-next');
const btnPrev  = document.getElementById('btn-prev');
const progFill = document.getElementById('prog-fill');
const progWrap = document.getElementById('prog-wrap');
const tCur     = document.getElementById('t-cur');
const tDur     = document.getElementById('t-dur');
const npTitle  = document.getElementById('np-title');
const npArtist = document.getElementById('np-artist');
const eqBars   = document.getElementById('eq-bars');
const volSlider= document.getElementById('volume');
const visCanvas= document.getElementById('visualizer');
const visCtx   = visCanvas.getContext('2d');
const pxCanvas = document.getElementById('pixel-canvas');
const pxCtx    = pxCanvas.getContext('2d');
const tbody    = document.getElementById('song-tbody');
const searchIn = document.getElementById('search');
const toast    = document.getElementById('toast');
const sbCount  = document.getElementById('sb-count');
const sbTime   = document.getElementById('sb-time');

// ── Toast ─────────────────────────────────────────────────────────────────────
let toastTimer;
function showToast(msg, type='info') {
  toast.textContent = msg;
  toast.className   = type;
  toast.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.style.display='none', 3000);
}

// ── Time format ───────────────────────────────────────────────────────────────
function fmt(s) {
  if (!isFinite(s) || s < 0) return '0:00';
  const m = Math.floor(s / 60), ss = Math.floor(s % 60);
  return `${m}:${ss.toString().padStart(2,'0')}`;
}

// ── Status clock ──────────────────────────────────────────────────────────────
setInterval(() => {
  sbTime.textContent = new Date().toLocaleTimeString('ja-JP', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
}, 1000);

// ── Pixel art album cover (procedural) ───────────────────────────────────────
function drawPixelArt(seed) {
  const pal = [
    '#00ffcc','#ff00aa','#ffcc00','#ff4466','#44ff88',
    '#0088ff','#ff8800','#cc44ff','#00ccff','#ff6644'
  ];
  const rng = seed => {
    let s = seed;
    return () => { s = (s * 1664525 + 1013904223) & 0xffffffff; return (s >>> 0) / 0xffffffff; };
  };
  const r   = rng(seed || 42);
  const W   = 8; // draw on 8x8, upscale
  pxCtx.clearRect(0, 0, 16, 16);
  for (let y = 0; y < W; y++) {
    for (let x = 0; x < W / 2; x++) {
      if (r() > 0.4) {
        const col = pal[Math.floor(r() * pal.length)];
        pxCtx.fillStyle = col;
        pxCtx.fillRect(x*2, y*2, 2, 2);
        pxCtx.fillRect((W-1-x)*2, y*2, 2, 2);
      }
    }
  }
}

// ── Pixel visualizer ─────────────────────────────────────────────────────────
function resizeVis() {
  visCanvas.width  = visCanvas.offsetWidth;
  visCanvas.height = visCanvas.offsetHeight;
}
resizeVis();
window.addEventListener('resize', resizeVis);

function drawVis() {
  visRaf = requestAnimationFrame(drawVis);
  const W = visCanvas.width, H = visCanvas.height;
  visCtx.fillStyle = '#000';
  visCtx.fillRect(0, 0, W, H);

  if (!analyser) {
    // Idle: static line
    visCtx.strokeStyle = 'rgba(0,255,200,0.15)';
    visCtx.beginPath();
    visCtx.moveTo(0, H/2); visCtx.lineTo(W, H/2);
    visCtx.stroke();
    return;
  }

  const data  = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);

  const barW  = Math.max(2, Math.floor(W / 64));
  const gap   = 1;
  const count = Math.floor(W / (barW + gap));

  // Palette cycle
  const t = Date.now() / 1000;
  for (let i = 0; i < count; i++) {
    const di   = Math.floor(i / count * data.length);
    const val  = data[di] / 255;
    const bH   = Math.max(2, Math.floor(val * H));
    const hue  = (i / count * 180 + t * 60) % 360;
    // Pixel-quantize height to 4px steps
    const qH   = Math.floor(bH / 4) * 4;
    visCtx.fillStyle = `hsl(${hue},100%,60%)`;
    visCtx.fillRect(i * (barW + gap), H - qH, barW, qH);
    // Top pixel highlight
    visCtx.fillStyle = '#fff';
    visCtx.fillRect(i * (barW + gap), H - qH, barW, 2);
  }
}
drawVis();

// ── Web Audio setup ───────────────────────────────────────────────────────────
function setupAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  srcNode  = audioCtx.createMediaElementSource(player);
  srcNode.connect(analyser);
  analyser.connect(audioCtx.destination);
}

// ── Media Session API ─────────────────────────────────────────────────────────
function setupMediaSession() {
  if (!('mediaSession' in navigator)) return;

  navigator.mediaSession.setActionHandler('play', async () => {
    setupAudio();
    if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();
    player.play().then(() => setPlaying(true)).catch(console.warn);
  });

  navigator.mediaSession.setActionHandler('pause', () => {
    player.pause();
    setPlaying(false);
  });

  navigator.mediaSession.setActionHandler('nexttrack', () => nextRandom());
  navigator.mediaSession.setActionHandler('previoustrack', () => prevSong());

  navigator.mediaSession.setActionHandler('seekto', e => {
    if (e.seekTime !== undefined && player.duration) {
      player.currentTime = e.seekTime;
    }
  });

  navigator.mediaSession.setActionHandler('seekforward', e => {
    player.currentTime = Math.min(player.duration, player.currentTime + (e.seekOffset || 10));
  });

  navigator.mediaSession.setActionHandler('seekbackward', e => {
    player.currentTime = Math.max(0, player.currentTime - (e.seekOffset || 10));
  });
}

function updateMediaSessionMetadata(song) {
  if (!('mediaSession' in navigator)) return;

  // ピクセルアートをDataURLに変換してアートワークに使う
  const artUrl = pxCanvas.toDataURL('image/png');

  navigator.mediaSession.metadata = new MediaMetadata({
    title:  song.title,
    artist: song.artist,
    album:  'CHIP.STREAM',
    artwork: [
      { src: artUrl, sizes: '96x96',   type: 'image/png' },
      { src: artUrl, sizes: '128x128', type: 'image/png' },
    ]
  });
}

function updateMediaSessionPlaybackState(playing) {
  if (!('mediaSession' in navigator)) return;
  navigator.mediaSession.playbackState = playing ? 'playing' : 'paused';
}

// PositionState（シークバー）の更新
player.addEventListener('timeupdate', () => {
  if (!player.duration || !('mediaSession' in navigator)) return;
  try {
    navigator.mediaSession.setPositionState({
      duration:     player.duration,
      playbackRate: player.playbackRate,
      position:     player.currentTime,
    });
  } catch(e) { /* ignore */ }
});

setupMediaSession();

// ── Load & play a song ────────────────────────────────────────────────────────
async function playSong(song) {
  if (!song) return;
  if (current) history.push(current.id);
  current  = song;

  npTitle.textContent  = song.title;
  npArtist.textContent = song.artist;

  // Procedural pixel art from song id hash
  let seed = 0;
  for (const c of song.id) seed = (seed * 31 + c.charCodeAt(0)) | 0;
  drawPixelArt(seed);

  // Marquee update
  document.getElementById('marquee-text').textContent =
    `★ NOW PLAYING: ${song.title} — ${song.artist} ★ `.repeat(5);

  player.src = `${API}/stream/${song.id}`;
  player.volume = parseFloat(volSlider.value);

  try {
    setupAudio();
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    await player.play();
    setPlaying(true);
  } catch(e) {
    console.warn(e);
    showToast('PLAYBACK ERROR: ' + e.message, 'error');
  }

  highlightActive();

  // Media Session メタデータ更新（pixel artが描かれた後）
  updateMediaSessionMetadata(song);
}

function setPlaying(v) {
  isPlaying = v;
  btnPlay.textContent = v ? '⏸ 一時停止' : '再生';
  eqBars.classList.toggle('paused', !v);
  updateMediaSessionPlaybackState(v);
}

// ── Auto-next ─────────────────────────────────────────────────────────────────
player.addEventListener('ended', () => nextRandom());

async function nextRandom() {
  try {
    const excl = current ? current.id : '';
    const res  = await fetch(`${API}/api/random?exclude=${excl}`);
    if (!res.ok) return;
    const song = await res.json();
    playSong(song);
  } catch(e) { console.warn(e); }
}

async function prevSong() {
  if (history.length === 0) return;
  const prevId = history.pop();
  const song   = songs.find(s => s.id === prevId);
  if (song) {
    // Don't push to history in this case
    const cur = current;
    current = null;
    await playSong(song);
    // fix: put cur back as last history if we want to go forward again
  }
}

// ── Controls ──────────────────────────────────────────────────────────────────
btnPlay.addEventListener('click', async () => {
  if (!current) { await nextRandom(); return; }
  setupAudio();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  if (isPlaying) { player.pause(); setPlaying(false); }
  else           { player.play().then(()=>setPlaying(true)).catch(console.warn); }
});

btnNext.addEventListener('click', nextRandom);
btnPrev.addEventListener('click', prevSong);
volSlider.addEventListener('input', () => player.volume = parseFloat(volSlider.value));

// Progress
player.addEventListener('timeupdate', () => {
  if (!player.duration) return;
  const pct = player.currentTime / player.duration * 100;
  progFill.style.width = pct + '%';
  tCur.textContent = fmt(player.currentTime);
  tDur.textContent = fmt(player.duration);
});

progWrap.addEventListener('click', e => {
  if (!player.duration) return;
  const rect = progWrap.getBoundingClientRect();
  player.currentTime = (e.clientX - rect.left) / rect.width * player.duration;
});

// ── Song list ─────────────────────────────────────────────────────────────────
async function loadSongs(q = '') {
  try {
    const url  = q ? `${API}/api/songs?q=${encodeURIComponent(q)}` : `${API}/api/songs`;
    const res  = await fetch(url);
    songs      = await res.json();
    renderList(songs);
    sbCount.textContent = `SONGS: ${songs.length}`;
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty">ERROR LOADING SONGS</div></td></tr>`;
  }
}

function renderList(list) {
  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty">NO SONGS FOUND<br>──────────────<br>BE THE FIRST TO UPLOAD!</div></td></tr>`;
    return;
  }

  tbody.innerHTML = list.map((s, i) => `
    <tr class="song-row${current && current.id===s.id ? ' active' : ''}" data-id="${s.id}">
      <td class="t-num">${i + 1}</td>
      <td class="t-title" title="${esc(s.title)}">${esc(s.title)}</td>
      <td class="t-artist">${esc(s.artist)}</td>
      <td class="t-ext">${s.ext.replace('.','').toUpperCase()}</td>
      <td class="t-date">${s.uploaded.slice(0,10)}</td>
      <td class="t-del"><button class="del-btn" data-id="${s.id}" title="Delete">✕</button></td>
    </tr>
  `).join('');

  // Row click → play
  tbody.querySelectorAll('.song-row').forEach(row => {
    row.addEventListener('click', e => {
      if (e.target.classList.contains('del-btn')) return;
      const s = songs.find(x => x.id === row.dataset.id);
      if (s) playSong(s);
    });
  });

  // Delete button
  tbody.querySelectorAll('.del-btn').forEach(btn => {
    btn.addEventListener('click', async e => {
      e.stopPropagation();
      if (!confirm('DELETE THIS SONG?')) return;
      const id = btn.dataset.id;
      await fetch(`${API}/api/songs/${id}`, { method: 'DELETE' });
      if (current && current.id === id) { player.pause(); setPlaying(false); current = null; }
      loadSongs(searchIn.value.trim());
      showToast('SONG DELETED', 'error');
    });
  });
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function highlightActive() {
  document.querySelectorAll('.song-row').forEach(r => {
    r.classList.toggle('active', current && r.dataset.id === current.id);
  });
}

searchIn.addEventListener('input', () => loadSongs(searchIn.value.trim()));
document.getElementById('btn-refresh').addEventListener('click', () => loadSongs(searchIn.value.trim()));

// ── Upload ────────────────────────────────────────────────────────────────────
const fileDrop   = document.getElementById('file-drop');
const fileInput  = document.getElementById('u-file');
const fileLabel  = document.getElementById('file-label');
const uploadStat = document.getElementById('upload-status');

fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) fileLabel.textContent = '▲ ' + fileInput.files[0].name;
});

fileDrop.addEventListener('dragover', e => { e.preventDefault(); fileDrop.classList.add('drag-over'); });
fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('drag-over'));
fileDrop.addEventListener('drop', e => {
  e.preventDefault();
  fileDrop.classList.remove('drag-over');
  const f = e.dataTransfer.files[0];
  if (f) { fileInput.files = e.dataTransfer.files; fileLabel.textContent = '▲ ' + f.name; }
});

document.getElementById('btn-upload').addEventListener('click', async () => {
  const title  = document.getElementById('u-title').value.trim();
  const artist = document.getElementById('u-artist').value.trim();
  const comment= document.getElementById('u-comment').value.trim();
  const file   = fileInput.files[0];

  if (!file)   { showToast('SELECT A FILE FIRST!', 'error'); return; }
  if (!title)  { showToast('ENTER A TITLE!', 'error'); return; }
  if (!artist) { showToast('ENTER AN ARTIST NAME!', 'error'); return; }

  const fd = new FormData();
  fd.append('title',   title);
  fd.append('artist',  artist);
  fd.append('comment', comment);
  fd.append('file',    file);

  uploadStat.textContent = 'UPLOADING...';
  document.getElementById('btn-upload').disabled = true;

  try {
    const res  = await fetch(`${API}/api/upload`, { method: 'POST', body: fd });
    const data = await res.json();
    if (data.ok) {
      showToast('UPLOAD COMPLETE! ▲', 'success');
      uploadStat.textContent = '';
      document.getElementById('u-title').value   = '';
      document.getElementById('u-artist').value  = '';
      document.getElementById('u-comment').value = '';
      fileInput.value = '';
      fileLabel.textContent = '音声ファイルをここにドラッグ';
      loadSongs();
    } else {
      showToast('ERROR: ' + (data.error || 'UNKNOWN'), 'error');
      uploadStat.textContent = 'FAILED';
    }
  } catch(e) {
    showToast('NETWORK ERROR', 'error');
    uploadStat.textContent = 'ERROR';
  }
  document.getElementById('btn-upload').disabled = false;
});

// ── Service Worker 登録（バックグラウンド再生維持）────────────────────────────
if ('serviceWorker' in navigator) {
  const swCode = `
    self.addEventListener('install', e => self.skipWaiting());
    self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
    self.addEventListener('fetch', e => {
      // audio streamのリクエストはネットワーク優先でそのまま通す
      e.respondWith(fetch(e.request).catch(() => new Response('', {status: 503})));
    });
  `;
  const swBlob = new Blob([swCode], { type: 'application/javascript' });
  const swUrl  = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl, { scope: '/' }).catch(console.warn);
}

// ── iOS バックグラウンド復帰対策 ─────────────────────────────────────────────
// スクリーンがロック解除されたり、タブが前面に戻ったときにAudioContextを再開
document.addEventListener('visibilitychange', async () => {
  if (document.visibilityState === 'visible' && audioCtx && audioCtx.state === 'suspended') {
    try { await audioCtx.resume(); } catch(e) { console.warn(e); }
  }
});

// ── Init ──────────────────────────────────────────────────────────────────────
loadSongs();
</script>
</body>
</html>
